# Stock Sync Service

Сервис для автоматической синхронизации данных об остатках товаров со складов через API в базу данных MySQL.

## Возможности

- ✅ Интеграция с API МойСклад
- ✅ Поддержка Basic Auth и Bearer Token авторизации
- ✅ Автоматическая синхронизация по расписанию (cron)
- ✅ Ручной запуск синхронизации через API endpoint
- ✅ Поддержка пагинации API (до 1000 записей за запрос)
- ✅ Логирование всех операций в файл
- ✅ Запись данных с текущей датой
- ✅ Управление списком складов через текстовый файл
- ✅ Настройка через переменные окружения

## Требования

- Node.js (версия 14 или выше)
- MySQL (версия 5.7 или выше)
- Windows (или любая другая ОС с поддержкой Node.js)

## Установка

1. **Клонирование репозитория (или создание проекта)**
```bash
cd StockSyncLamp
```

2. **Установка зависимостей**
```bash
npm install
```

3. **Настройка переменных окружения**

Создайте файл `.env` на основе `.env.example`:
```bash
copy .env.example .env
```

Отредактируйте файл `.env` и укажите ваши настройки:
```env
# API Configuration (МойСклад)
API_URL=https://api.moysklad.ru/api/remap/1.2/report/stock/all

# Вариант 1: Аутентификация по токену (Bearer Token)
# API_TOKEN=your_access_token_here

# Вариант 2: Аутентификация Basic Auth (логин и пароль)
API_LOGIN=your_login_here
API_PASSWORD=your_password_here

# Database Configuration
DB_HOST=localhost
DB_PORT=3306
DB_NAME=stock_sync
DB_USER=root
DB_PASSWORD=your_password_here

# Application Configuration
PORT=3000
CRON_SCHEDULE=0 0 * * *
LOG_FILE=logs/sync.log

# Timezone
TZ=Europe/Moscow
```

**Важно:** Укажите **либо** `API_TOKEN` (для Bearer Token), **либо** `API_LOGIN` и `API_PASSWORD` (для Basic Auth).

4. **Создание базы данных**

Создайте базу данных MySQL:
```sql
CREATE DATABASE stock_sync CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

5. **Настройка списка складов**

Отредактируйте файл `warehouses.txt` и добавьте **ID (UUID) складов** из МойСклад (по одному на строку):
```
# Как найти ID склада: см. WAREHOUSES_GUIDE.md
12345678-1234-1234-1234-123456789abc
87654321-4321-4321-4321-cba987654321
```

**Важно:** Нужны ID складов в формате UUID, а не их названия.  
**Подробнее:** См. файл `WAREHOUSES_GUIDE.md`

## Запуск

### Режим разработки (с автоперезагрузкой)
```bash
npm run dev
```

### Продакшн режим
```bash
npm start
```

### Запуск как Windows служба (опционально)

Для запуска как службы Windows можно использовать утилиты типа `node-windows` или `pm2`.

Пример с pm2:
```bash
npm install -g pm2
pm2 start server.js --name stock-sync
pm2 save
pm2 startup
```

## API Endpoints

### GET /
Информация о сервисе

### GET /health
Проверка состояния сервиса и подключения к БД

**Ответ:**
```json
{
  "status": "ok",
  "database": "connected",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### POST /sync/manual
Ручной запуск синхронизации

**Ответ:**
```json
{
  "message": "Синхронизация запущена",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### GET /sync/status
Статус последней синхронизации и информация о расписании

## Настройка расписания CRON

Переменная `CRON_SCHEDULE` в файле `.env` использует стандартный формат cron:

```
* * * * *
│ │ │ │ │
│ │ │ │ └─── День недели (0-7, 0 и 7 = воскресенье)
│ │ │ └───── Месяц (1-12)
│ │ └─────── День месяца (1-31)
│ └───────── Час (0-23)
└─────────── Минута (0-59)
```

**Примеры:**
- `0 0 * * *` - каждый день в полночь
- `0 2 * * *` - каждый день в 2:00
- `0 */6 * * *` - каждые 6 часов
- `30 8 * * 1-5` - в 8:30 по будням

## Формат логов

Логи записываются в файл (по умолчанию `logs/sync.log`) в следующем формате:

```
2024-01-01T00:00:00.000Z | WAREHOUSE_01 | SUCCESS | Records: 150
2024-01-01T00:00:00.000Z | WAREHOUSE_02 | SUCCESS | Records: 203
2024-01-01T00:00:00.000Z | WAREHOUSE_03 | ERROR | Records: 0 | Error: Connection timeout
```

## Структура проекта

```
StockSyncLamp/
├── config/
│   └── database.js          # Конфигурация подключения к БД
├── models/
│   ├── index.js             # Инициализация Sequelize
│   └── Stock.js             # Модель таблицы остатков
├── services/
│   ├── apiService.js        # Работа с внешним API
│   └── syncService.js       # Логика синхронизации
├── utils/
│   └── logger.js            # Логирование
├── logs/                    # Директория для логов (создается автоматически)
├── warehouses.txt           # Список складов
├── .env                     # Переменные окружения (не в git)
├── .env.example             # Пример файла .env
├── .gitignore
├── package.json
├── README.md
└── server.js                # Основной файл приложения
```

## Доработка под конкретное API

После получения примера ответа API и структуры таблицы БД необходимо:

1. **Обновить модель** в `models/Stock.js` - добавить все поля таблицы
2. **Обновить apiService.js** - настроить правильную пагинацию и параметры запроса
3. **Обновить syncService.js** - настроить маппинг полей из API в модель БД

## Устранение неполадок

### Сервис не подключается к БД
- Проверьте правильность настроек в `.env`
- Убедитесь, что MySQL запущен
- Проверьте права пользователя БД

### Не работает cron
- Проверьте формат CRON_SCHEDULE
- Убедитесь, что сервис запущен и работает

### API возвращает ошибки
- Проверьте API_KEY и API_URL
- Убедитесь, что API доступен
- Проверьте логи для деталей ошибки

## Лицензия

ISC

